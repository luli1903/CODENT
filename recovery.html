<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Restablecer contraseña</title>
</head>
<body style="max-width:560px;margin:40px auto;padding:16px;font-family:system-ui">
  <h2>Restablecer contraseña</h2>
  <p>Ingresá tu nueva contraseña para tu cuenta.</p>

  <label>Nueva contraseña</label>
  <input id="newPass" type="password" style="width:100%;padding:10px">

  <label style="display:block;margin-top:8px">Repetir contraseña</label>
  <input id="newPass2" type="password" style="width:100%;padding:10px">

  <div id="recMsg" style="min-height:22px;margin-top:8px;color:#b00020"></div>
  <button id="setNew" style="margin-top:12px;padding:10px 16px">Guardar nueva contraseña</button>

  <script type="module">
    import { supabase } from "/js/supabaseClient.js";

    const msg = document.getElementById("recMsg");
    const btn = document.getElementById("setNew");
    const busy = (b)=>{ btn.disabled=!!b; btn.dataset.t ||= btn.textContent; btn.textContent=b?"Procesando...":btn.dataset.t; };

    async function asegurarSesion(){
      try{
        const url = new URL(location.href);
        const code = url.searchParams.get("code");
        if (code){
          const { error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
        } else {
          for (let i=0;i<10;i++){
            const { data:{session} } = await supabase.auth.getSession();
            if(session) break;
            await new Promise(r=>setTimeout(r,150));
          }
        }
      } catch(e){
        msg.textContent = e?.message || "No pudimos validar el enlace. Volvé a solicitarlo.";
      }
    }

    async function guardar(){
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("newPass2").value;
      msg.style.color="#b00020"; msg.textContent=""; busy(true);

      try{
        if (!p1 || p1.length<8) throw new Error("Usá al menos 8 caracteres.");
        if (p1 !== p2) throw new Error("Las contraseñas no coinciden.");

        const { data:{session} } = await supabase.auth.getSession();
        if (!session) throw new Error("El enlace expiró o no se abrió correctamente. Reintentá desde el mail.");

        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) throw error;

        msg.style.color="green";
        msg.textContent="¡Listo! Contraseña actualizada.";
        setTimeout(()=> location.href="/admin/", 1200);
      }catch(err){
        msg.textContent = err?.message || "No pudimos actualizar la contraseña.";
      }finally{
        busy(false);
      }
    }

    await asegurarSesion();
    btn.addEventListener("click", guardar);
  </script>
</body>
</html>
