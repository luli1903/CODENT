<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Restablecer contraseña</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:40px auto;max-width:560px;padding:16px}
    label{display:block;margin:10px 0 4px}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
    button{margin-top:12px;padding:10px 16px;border:0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    #recMsg{min-height:22px;margin-top:8px;color:#b00020;white-space:pre-wrap}
    .ok{color:green}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <h2>Restablecer contraseña</h2>
  <p class="muted">Ingresá tu nueva contraseña para tu cuenta.</p>

  <label>Nueva contraseña</label>
  <input id="newPass" type="password" placeholder="Mínimo 8 caracteres">

  <label>Repetir contraseña</label>
  <input id="newPass2" type="password" placeholder="Repetir contraseña">

  <div id="recMsg"></div>
  <button id="setNew">Guardar nueva contraseña</button>
<script>
  // ⚠️ REEMPLAZÁ por los valores de tu proyecto
  window.VITE_SUPABASE_URL = "https://chzofyepqjomxfekvoux.supabase.co";
  window.VITE_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoem9meWVwcWpvbXhmZWt2b3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjQ2MjMsImV4cCI6MjA3MzAwMDYyM30.gldAo40K-YCPNdzgvDsqDpDtvYCTPn7KnVsww_RYFUw";
</script>

  <script type="module">
    const msg = document.getElementById("recMsg");
    const btn = document.getElementById("setNew");
    const busy = (b)=>{ btn.disabled=!!b; btn.dataset.t ||= btn.textContent; btn.textContent=b?"Procesando...":btn.dataset.t; };

    // ---- Cargar/crear cliente Supabase de forma robusta ----
    let supabase;
    try{
      // Intenta usar tu cliente del proyecto
      const m = await import("/js/supabaseClient.js");
      supabase = m.supabase;
      if(!supabase) throw new Error("No exportó supabase");
    }catch{
      // Fallback: crear cliente directo (requiere que tengas definidas las vars globales)
      const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
      const url = window.VITE_SUPABASE_URL;
      const key = window.VITE_SUPABASE_ANON_KEY;
      if(!url || !key){
        msg.textContent =
          "No pudimos cargar el cliente de Supabase.\n" +
          "Solución rápida: definí window.VITE_SUPABASE_URL y window.VITE_SUPABASE_ANON_KEY en un <script> antes de este.\n" +
          "O asegurate de que /js/supabaseClient.js existe y exporta 'supabase'.";
        throw new Error("Falta configuración de Supabase");
      }
      supabase = createClient(url, key);
    }

    let recoveryReady = false;

    async function ensureRecoverySession(){
      try{
        const url = new URL(location.href);
        const code = url.searchParams.get("code");

        if (code){
          const { error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) throw error;
          recoveryReady = true;
          return;
        }

        // hash flow (#access_token=…)
        for (let i=0;i<20;i++){ // ~3s
          const { data:{ session } } = await supabase.auth.getSession();
          if (session){ recoveryReady = true; break; }
          await new Promise(r=>setTimeout(r,150));
        }
      }catch(e){
        msg.textContent = (e && e.message) || "No pudimos validar el enlace. Solicitá uno nuevo desde “Recuperar”.";
      }
    }

    // Por si el SDK notifica explícitamente
    supabase?.auth.onAuthStateChange((event)=>{ if(event==="PASSWORD_RECOVERY") recoveryReady = true; });

    async function paintStatus(){
      try{
        const { data:{ session } } = await supabase.auth.getSession();
        if(session){
          msg.classList.add("ok");
          msg.textContent = `Enlace válido para: ${session.user?.email || "tu cuenta"} ✅`;
        }else{
          msg.classList.remove("ok");
          msg.textContent = "Enlace inválido o expirado ❌ — solicitá uno nuevo desde “Recuperar”.";
        }
      }catch(e){
        msg.textContent = e?.message || "No pudimos verificar el estado del enlace.";
      }
    }

    async function saveNewPassword(){
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("newPass2").value;
      msg.classList.remove("ok");
      msg.textContent = "";
      busy(true);

      try{
        if(!p1 || p1.length<8) throw new Error("Usá al menos 8 caracteres.");
        if(p1!==p2) throw new Error("Las contraseñas no coinciden.");

        if(!recoveryReady){
          const { data:{ session } } = await supabase.auth.getSession();
          if(!session) throw new Error("El enlace expiró o no creó sesión. Volvé a solicitarlo desde el botón Recuperar.");
        }

        const { error } = await supabase.auth.updateUser({ password: p1 });
        if(error) throw error;

        msg.classList.add("ok");
        msg.textContent = "¡Listo! Contraseña actualizada.";
        setTimeout(async ()=>{
          try{ await supabase.auth.signOut(); }catch{}
          location.href = "/admin/"; // o "/" si preferís volver a la home
        }, 900);
      }catch(err){
        msg.textContent = err?.message || "No pudimos actualizar la contraseña.";
      }finally{
        busy(false);
      }
    }

    // Debug visible si algo rompe antes
    window.onerror = (m, src, ln, col, err)=>{
      msg.textContent = "Error: " + (m || (err && err.message) || "desconocido");
    };

    await ensureRecoverySession();
    await paintStatus();
    btn.addEventListener("click", saveNewPassword);
  </script>
</body>
</html>

